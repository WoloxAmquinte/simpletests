def TAG_TEST
def EMAIL_SUCCESS
def EMAIL_FAILURE

NAME_TEST = "INVESTIGATION PROJECT"

pipeline {
    agent any

    stages {
        stage('Get Source') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: '284774ba-98f3-4b7e-ba8f-5cf0a6f8e7e9', url: 'https://github.com/WoloxAmquinte/simpletests.git']]])
            }
        }

        stage('Run Tests') {
            steps {
                catchError{
                    echo "RUNNING CLEAN"
                    sh "chmod +x gradlew"
                    sh "./gradlew clean"
            		echo "RUNNING TEST"
                    //sh './gradlew test -Dcucumber.options="-tags @${TAG_TEST}"'
                    sh './gradlew test --info -DregressionType="@${TAG_TEST}"'

                    script {
                            currentBuild.result = 'SUCCESS'
                    }
                    echo "The test result is: '${currentBuild.result}'"
                }
            }

        }

        stage ('Generate Evidence'){
              steps{
                step([$class: 'CucumberReportPublisher', jsonReportDirectory: 'target/', fileIncludePattern: '*.json'])
                script{
                       print "The results of the execution can be found at the following URL: ";
                       intTestURL = env.BUILD_URL + "cucumber-html-reports/overview-features.html";
                       print intTestURL;
                }
              }
        }

        stage('Notify') {
            steps {
                  catchError{
                      script{
                        sendEmail(currentBuild.result)
                      }
                }
            }
        }
    }
}
def sendEmail(resultTest) {
    def subjectText = "";
    def receiver = "";
    def result = "";
        if(resultTest == "SUCCESS"){
                      receiver = "${EMAIL_SUCCESS}"
                      subjectText = "SUCCESSFUL EXECUTION OF ${NAME_TEST}"
                      result = "Job success - \"${env.JOB_NAME}\" build: ${env.BUILD_NUMBER}\n\n"
        } else {
                      receiver = "${EMAIL_FAILURE}"
                      subjectText = "FAILED EXECUTION OF ${NAME_TEST}"
                      result = "Job failed - \"${env.JOB_NAME}\" build: ${env.BUILD_NUMBER}\n\n"
        }
    def bodyText = """<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                      <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
                      <head>
                          <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
                          <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
                          <meta http-equiv="X-UA-Compatible" content="IE=edge" />
                          <meta name="format-detection" content="date=no" />
                          <meta name="format-detection" content="address=no" />
                          <meta name="format-detection" content="telephone=no" />
                          <meta name="x-apple-disable-message-reformatting" />
                          <link href="https://fonts.googleapis.com/css?family=Poppins:400,400i,700,700i" rel="stylesheet" />

                          <style type="text/css" media="screen">
                          body { padding:0 !important; margin:0 !important; display:block !important; min-width:100% !important; width:100% !important; background:#FFF; -webkit-text-size-adjust:none }
                          a { color:#66c7ff; text-decoration:none }
                          p { padding:0 !important; margin:0 !important }
                          img { -ms-interpolation-mode: bicubic; }
                          .mcnPreviewText { display: none !important; }


                          @media only screen and (max-device-width: 480px), only screen and (max-width: 480px) {
                            .mobile-shell { width: 100% !important; min-width: 100% !important; }
                            .bg { background-size: 100% auto !important; -webkit-background-size: 100% auto !important; }
                            .text-nav,
                            .text-header,
                            .m-center { text-align: center !important;line-height: 36px;}
                            .execTitle { border: none !important; }
                            .center { margin: 0 auto !important; }
                            .container { padding: 10px 10px 10px 10px !important }
                            .td { width: 100% !important; min-width: 100% !important; }
                            .mbr img { border-radius: 8px !important; }
                            .brl  { border-radius: 10px !important; }
                            .brr  { border-radius: 10px !important; }
                            .text-nav { line-height: 28px !important; }
                            .p30 { padding: 15px !important; }
                            .m-br-15 { height: 15px !important; }
                            .p30-15 { padding: 30px 15px !important; }
                            .p40 { padding: 20px !important; }
                            .m-td,
                            .m-hide { display: none !important; width: 0 !important; height: 0 !important; font-size: 0 !important; line-height: 0 !important; min-height: 0 !important; }
                            .m-block { display: block !important; }
                            .fluid-img img { width: 100% !important; max-width: 100% !important; height: auto !important; }
                            .column,
                            .column-dir,
                            .column-top,
                            .column-empty,
                            .column-empty2,
                            .column-dir-top { float: left !important; width: 100% !important; display: block !important; }
                            .column-empty { padding-bottom: 10px !important; }
                            .column-empty2 { padding-bottom: 20px !important; }
                            .content-spacing { width: 15px !important; }
                          }
                        </style>
                      </head>
                      <body class="body" style="padding:0 !important; margin:0 !important; display:block !important; min-width:100% !important; width:100% !important; background:#FFF; -webkit-text-size-adjust:none;">
                          <h1><img alt="" src="https://d27i7n2isjbnbi.cloudfront.net/careers/photos/186181/thumb_photo_1601923210.png" /></h1>

                      <table width="100%" border="0" cellspacing="0" cellpadding="0" bgcolor="#e1dad3">
                          <tr>
                              <td align="center" valign="top">
                                  <table width="650" border="0" cellspacing="0" cellpadding="0" class="mobile-shell">
                                      <tr>
                                          <td class="td container" style="width:650px; min-width:650px; font-size:0pt; line-height:0pt; margin:0; font-weight:normal; padding:10px 0px 40px 0px;">
                                              <!-- Header -->
                                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                  <tr>
                                                      <td class="p30-15 tbrr" style="padding:10px 10px 10px 40px; border-radius:10px 10px 0px 0px;" bgcolor="#FFF">
                                                          <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                              <tr>
                                                                  <th class="column-top" width="100%" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; vertical-align:middle;">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="text-header" style="font-family:'Segoe UI';letter-spacing:2px; font-size:30px; line-width:36px; text-align:center ;">${result}</td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                                  <th class="column-empty" width="1" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; vertical-align:top;"></th>
                                                              </tr>
                                                          </table>
                                                      </td>
                                                  </tr>
                                              </table>
                                              <!-- END Header -->

                                              <!-- Logo + Resultado ejecución -->
                                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                  <tr>
                                                      <td class="p30-15" style="padding: 25px 30px;" bgcolor="#CBD4D8" align="center">
                                                          <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                              <tr>
                                                                  <th class="column" width="140" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal;">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="img m-center" style="font-size:0pt; line-height:0pt; text-align:left;">
                                                                                  <img src="https://d27i7n2isjbnbi.cloudfront.net/careers/photos/186181/thumb_photo_1601923210.png" width="126" height="25" border="0" alt="" /></td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                                  <th class="column-empty" width="1" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; vertical-align:top;"></th>
                                                                  <th class="column" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal;max-width:350px">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="text-nav" style="line-height:18px; text-align:center; text-transform:uppercase;">
                                                                                  <span style="color:#14161C; font-family:'Segoe UI';letter-spacing:2px; font-size:14px; word-wrap: break-word;">
                                                                                      <b>PROJECT: <br>${NAME_TEST}</b></span>
                                                                              </td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                              </tr>
                                                          </table>
                                                      </td>
                                                  </tr>
                                              </table>
                                              <!-- END Logo + Resultado ejecución -->

                                              <!-- Hero -->
                                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                  <tr>
                                                      <td style="padding-bottom: 10px;">
                                                          <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                              <tr>
                                                                  <td class="fluid-img" style="font-size:0pt; line-height:0pt; text-align:left;"></td>
                                                              </tr>
                                                              <tr>
                                                                  <td class="p30-15 bbrr" style="padding: 40px; border-radius:0px 0px 10px 10px;" bgcolor="#03171A">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="h2 pb15" style="color:#FFF; font-family:'Poppins', Arial,sans-serif; font-size:18px; line-height:34px; text-align:left; padding-bottom:15px;max-width: 500px;word-break: break-all;">
                                                                                  <b>Job:</b> '${env.JOB_NAME} [${env.BUILD_NUMBER}]'</td>
                                                                          </tr>
                                                                          <tr>
                                                                              <td class="text" style="color:#FFF; font-family:'Poppins', Arial,sans-serif; font-size:15px; line-height:30px; text-align:left;">
                                                                                  Enter the links below to see more information
                                                                              </td>
                                                                          </tr>
                                                                      </table>
                                                                  </td>
                                                              </tr>
                                                          </table>
                                                      </td>
                                                  </tr>
                                              </table>
                                              <!-- END Hero -->


                                              <!-- Jenkins -->
                                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                  <tr>
                                                      <td style="padding-bottom: 10px;">
                                                          <table width="100%" border="0" cellspacing="0" cellpadding="0" dir="rtl" style="direction: rtl;">
                                                              <tr>
                                                                  <th class="column-dir" dir="ltr" width="245" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; direction:ltr;background:#f6efe7;border-radius:0px 10px 10px 0px">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="fluid-img mbr" style="font-size:0pt; line-height:0pt; text-align:center;"><img src="https://i.imgur.com/5zc24YS.png" border="0" alt="" /></td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                                  <th class="column-dir" dir="ltr" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; direction:ltr;">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="p30-15 brl" style="padding: 20px; border-radius:10px 0px 0px 10px;" bgcolor="#ffffff" height="100">
                                                                                  <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                                      <tr>
                                                                                          <td class="h3 pb20" style="color:#445942; font-family:'Poppins', Arial,sans-serif; font-size:14px; line-height:24px; text-align:center; padding-bottom:20px;">Check execution status in jenkins. </td>
                                                                                      </tr>

                                                                                      <!-- Button -->
                                                                                      <tr>
                                                                                          <td align="center">
                                                                                              <table border="0" cellspacing="0" cellpadding="0">
                                                                                                  <tr>
                                                                                                      <td class="text-button" style="background:#0A0B01; color:#ffffff; font-family:'Poppins', Arial,sans-serif; font-size:14px; line-height:18px; padding:12px 30px; text-align:center; border-radius:22px;">
                                                                                                          <a href="${env.BUILD_URL}" target="_blank" class="link-white" style="color:#ffffff; text-decoration:none;">
                                                                                                              <span class="link-white" style="color:#FFF; text-decoration:none;"><b>Go to Jenkins</b></span></a></td>
                                                                                                  </tr>
                                                                                              </table>
                                                                                          </td>
                                                                                      </tr>
                                                                                      <!-- END Button -->
                                                                                  </table>
                                                                              </td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                              </tr>
                                                          </table>
                                                      </td>
                                                  </tr>
                                              </table>
                                              <!-- Jenkins -->

                                              <!-- Cucumber -->
                                              <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                  <tr>
                                                      <td style="padding-bottom: 10px;">
                                                          <table width="100%" border="0" cellspacing="0" cellpadding="0" dir="rtl" style="direction: rtl;">
                                                              <tr>
                                                                  <th class="column-dir" dir="ltr" width="245" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; direction:ltr;background:#f6efe7;border-radius:0px 10px 10px 0px">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="fluid-img mbr" style="font-size:0pt; line-height:0pt; text-align:center;"><img src="https://i.imgur.com/uIud7vj.png" border="0" alt="" /></td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                                  <th class="column-dir" dir="ltr" style="font-size:0pt; line-height:0pt; padding:0; margin:0; font-weight:normal; direction:ltr;">
                                                                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                          <tr>
                                                                              <td class="p30-15 brl" style="padding: 20px; border-radius:10px 0px 0px 10px;" bgcolor="#ffffff" height="100">
                                                                                  <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                                                                      <tr>
                                                                                          <td class="h3 pb20" style="color:#445942; font-family:'Poppins', Arial,sans-serif; font-size:14px; line-height:24px; text-align:center; padding-bottom:20px;">Review the cucumber result. </td>
                                                                                      </tr>

                                                                                      <!-- Button -->
                                                                                      <tr>
                                                                                          <td align="center">
                                                                                              <table border="0" cellspacing="0" cellpadding="0">
                                                                                                  <tr>
                                                                                                      <td class="text-button" style="background:#0A0B01; color:#ffffff; font-family:'Poppins', Arial,sans-serif; font-size:14px; line-height:18px; padding:12px 30px; text-align:center; border-radius:22px;">
                                                                                                          <a href="${intTestURL}" target="_blank" class="link-white" style="color:#ffffff; text-decoration:none;">
                                                                                                              <span class="link-white" style="color:#FFF; text-decoration:none;"><b>Go to Cucumber</b></span></a></td>
                                                                                                  </tr>
                                                                                              </table>
                                                                                          </td>
                                                                                      </tr>
                                                                                      <!-- END Button -->
                                                                                  </table>
                                                                              </td>
                                                                          </tr>
                                                                      </table>
                                                                  </th>
                                                              </tr>
                                                          </table>
                                                      </td>
                                                  </tr>
                                              </table>
                                              <!-- Cucumber -->

                                              <!-- Footer -->
                                              <center>
                                                  <table  border="0" cellspacing="0" cellpadding="0">
                                                      <tr>
                                                          <td class="p30-15 br" style="padding: 10px; border-radius:10px;" bgcolor="#f6efe7">
                                                              <table border="0" cellspacing="0" cellpadding="0">
                                                                  <tr>
                                                                      <td class="text-footer1 pb10" style="color:#777777; font-family:'Poppins', Arial,sans-serif; font-size:12px; line-height:20px; text-align:left;">Powered by:</td>
                                                                  </tr>
                                                                  <tr>
                                                                      <td class="fluid-img mbr" style="font-size:0pt; line-height:0pt; text-align:center;"><img src="https://d27i7n2isjbnbi.cloudfront.net/careers/photos/186181/thumb_photo_1601923210.png" border="0" alt="" /></td>
                                                                  </tr>
                                                              </table>
                                                          </td>
                                                      </tr>
                                                  </table>
                                              </center>
                                              <!-- END Footer -->
                                          </td>
                                      </tr>
                                  </table>
                              </td>
                          </tr>
                      </table>
                      </body>
                      </html>
                      """
        emailext (
            subject: "${subjectText}",
            body: "${bodyText}",
            to:"${receiver}",
            attachLog: true
          )

}